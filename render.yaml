services:
  # Your WhatsApp Assistant (Flask + Gemini)
  - type: web
    name: waha-gemini-assistant
    runtime: docker
    region: oregon
    plan: free
    dockerfilePath: ./Dockerfile
    autoDeploy: true
    envVars:
      - key: WAHA_URL
        value: https://whatsapp-service-8vgb.onrender.com/api/sendText
      - key: WAHA_SESSION
        value: default
      - key: WAHA_KEEPALIVE_INTERVAL
        value: 600
      # Spotify redirect must match your Flask callback route
      - key: SPOTIFY_REDIRECT_URI
        value: https://waha-gemini-assistant.onrender.com/callback

  # Lightweight WhatsApp Gateway (Memory Optimized)
  - type: web
    name: whatsapp-service
    runtime: docker
    region: oregon
    plan: free
    dockerfilePath: ./whatsapp-service/Dockerfile
    autoDeploy: true
    buildCommand: "docker build --build-arg DOCKER_MODE=mock -t whatsapp-service -f ./whatsapp-service/Dockerfile ."
    envVars:
      # Memory optimization: Use mock mode for maximum efficiency
      - key: ENABLE_REAL_WHATSAPP
        value: "false"
      - key: FORCE_MOCK_MODE
        value: "true"
      # Memory monitoring
      - key: MEMORY_THRESHOLD_MB
        value: "350"
      - key: NODE_OPTIONS
        value: "--max-old-space-size=256"
      # WhatsApp -> Assistant (public URL of Flask webhook)
      - key: WHATSAPP_HOOK_URL
        value: https://waha-gemini-assistant.onrender.com/webhook
      - key: WHATSAPP_HOOK_EVENTS
        value: message
      # Memory-efficient settings
      - key: SHOW_QR
        value: "false"
      - key: MAX_RECONNECT_ATTEMPTS
        value: "2"
      - key: INITIAL_RECONNECT_DELAY
        value: "10000"
      # Session management
      - key: SESSION_PATH
        value: "/app/session"
